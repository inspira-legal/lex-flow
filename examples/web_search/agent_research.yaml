# Example: AI Research Agent with Web Search
#
# This workflow demonstrates an AI agent that uses web search tools to
# research topics and provide informed answers.
#
# Prerequisites:
#   - pip install lexflow[ai,search]
#   - gcloud auth application-default login
#   - Set TAVILY_API_KEY environment variable
#
# Run:
#   TAVILY_API_KEY=your-key uv run lexflow examples/web_search/agent_research.yaml

workflows:
  - name: main
    interface:
      inputs: []
      outputs: []
    variables:
      model: null
      agent: null
      result: null
      error_msg: ""
    nodes:
      start:
        opcode: workflow_start
        next: print_header
        inputs: {}

      print_header:
        opcode: io_print
        next: store_model
        inputs:
          STRING:
            literal: "\n=== AI Research Agent with Web Search ===\n\n"

      # === Setup: Create Model and Agent ===

      create_model:
        opcode: pydantic_ai_create_vertex_model
        isReporter: true
        inputs:
          model_name:
            literal: "gemini-2.5-flash"
          project:
            literal: null
          location:
            literal: "us-central1"

      store_model:
        opcode: data_set_variable_to
        next: print_model_created
        inputs:
          VARIABLE:
            literal: "model"
          VALUE:
            node: create_model

      print_model_created:
        opcode: io_print
        next: store_agent
        inputs:
          STRING:
            literal: "1. Created Vertex AI model: gemini-2.5-flash\n"

      create_agent:
        opcode: pydantic_ai_create_agent
        isReporter: true
        inputs:
          model:
            variable: "model"
          instructions:
            literal: |
              You are a research assistant with access to web search tools.
              When asked about any topic, use the available tools to search for
              current information before providing your answer.

              Available tools:
              - web_search: General web search for any topic
              - web_search_news: Search for recent news articles
              - web_search_context: Get context optimized for answering questions

              Always cite your sources when providing information from search results.
              Be concise and accurate in your responses.

      store_agent:
        opcode: data_set_variable_to
        next: print_agent_created
        inputs:
          VARIABLE:
            literal: "agent"
          VALUE:
            node: create_agent

      print_agent_created:
        opcode: io_print
        next: run_with_try
        inputs:
          STRING:
            literal: "2. Created AI research agent with web search capabilities\n\n"

      # === Execute Agent with Error Handling ===

      run_with_try:
        opcode: control_try
        next: show_success
        inputs:
          TRY:
            branch: execute_agent
          CATCH1:
            exception_type: "TimeoutError"
            var: "error_msg"
            body:
              branch: handle_timeout
          CATCH2:
            exception_type: "ValueError"
            var: "error_msg"
            body:
              branch: handle_value_error
          CATCH3:
            exception_type: null
            var: "error_msg"
            body:
              branch: handle_generic

      # === Agent Call ===

      agent_call:
        opcode: ai_agent_with_tools
        isReporter: true
        inputs:
          agent:
            variable: "agent"
          messages:
            literal: |
              What are the latest developments in quantum computing?
              Search for recent news and provide a summary.
          tools:
            literal:
              - web_search
              - web_search_news
              - web_search_context
          output:
            literal: null
          max_tool_calls:
            literal: 5
          timeout_seconds:
            literal: 120

      execute_agent:
        opcode: data_set_variable_to
        next: null
        inputs:
          VARIABLE:
            literal: "result"
          VALUE:
            node: agent_call

      # === Error Handlers ===

      handle_timeout:
        opcode: io_print
        next: null
        inputs:
          STRING:
            literal: "\n[ERROR] Agent execution timed out. Try increasing timeout_seconds.\n"

      handle_value_error:
        opcode: io_print
        next: print_value_error_detail
        inputs:
          STRING:
            literal: "\n[ERROR] Configuration error: "

      print_value_error_detail:
        opcode: io_print
        next: null
        inputs:
          STRING:
            variable: error_msg

      handle_generic:
        opcode: io_print
        next: print_generic_detail
        inputs:
          STRING:
            literal: "\n[ERROR] Unexpected error: "

      print_generic_detail:
        opcode: io_print
        next: null
        inputs:
          STRING:
            variable: error_msg

      # === Success Path ===

      show_success:
        opcode: io_print
        next: show_response
        inputs:
          STRING:
            literal: "\n=== Research Results ===\n\n"

      get_text:
        opcode: dict_get
        isReporter: true
        inputs:
          d:
            variable: result
          key:
            literal: "text"

      show_response:
        opcode: io_print
        next: show_footer
        inputs:
          STRING:
            node: get_text

      show_footer:
        opcode: io_print
        next: null
        inputs:
          STRING:
            literal: "\n\n=== Research Complete ===\n"
