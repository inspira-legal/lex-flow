# Vault - Publish document ingestion message via PubSub
#
# Simulates what the API's load-documents script does: publishes a
# PubSub message to the document-uploaded topic for LexFlow to process.
#
# PubSub payload matches the API envelope format:
#   { type: "document-uploaded", version: 1, data: { documentId, workspaceId, gcsUri, fileName, mimeType } }
#
# Usage:
#   uv run lexflow examples/showcase/vault/publish_book.yaml \
#     --input document_id=6980e6a96e32a63d0a13972c \
#     --input workspace_id=62b9d55915370b1b00a1f86b \
#     --input gcs_uri=gs://mvp-personal-vault/62b9d55915370b1b00a1f86b/6980e6a96e32a63d0a13972c/document.pdf \
#     --input file_name=document.pdf
#
# Optional:
#   --input mime_type=application/pdf             MIME type
#   --input project_id=inspira-development       PubSub project
#   --input topic_name=document-uploaded         PubSub topic

workflows:
  - name: main
    interface:
      inputs: [document_id, workspace_id, gcs_uri, file_name, mime_type, project_id, topic_name]
      outputs: []

    variables:
      document_id: ""
      workspace_id: ""
      gcs_uri: ""
      file_name: ""
      mime_type: "application/pdf"
      project_id: "inspira-development"
      topic_name: "document-uploaded"
      message_dict: {}

    nodes:
      start:
        opcode: workflow_start
        next: create_publisher
        inputs: {}

      # Create PubSub publisher
      do_create_publisher:
        opcode: pubsub_create_publisher
        isReporter: true
        inputs:
          project_id:
            variable: project_id
          topic_name:
            variable: topic_name

      create_publisher:
        opcode: data_set_variable_to
        next: build_message
        inputs:
          VARIABLE:
            literal: "message_dict"
          VALUE:
            node: do_create_publisher

      # Build inner data dict (camelCase, matching API contract)
      data_base:
        opcode: dict_create
        isReporter: true
        inputs: {}

      data_with_document_id:
        opcode: dict_set
        isReporter: true
        inputs:
          d:
            node: data_base
          key:
            literal: "documentId"
          value:
            variable: document_id

      data_with_workspace_id:
        opcode: dict_set
        isReporter: true
        inputs:
          d:
            node: data_with_document_id
          key:
            literal: "workspaceId"
          value:
            variable: workspace_id

      data_with_gcs_uri:
        opcode: dict_set
        isReporter: true
        inputs:
          d:
            node: data_with_workspace_id
          key:
            literal: "gcsUri"
          value:
            variable: gcs_uri

      data_with_file_name:
        opcode: dict_set
        isReporter: true
        inputs:
          d:
            node: data_with_gcs_uri
          key:
            literal: "fileName"
          value:
            variable: file_name

      data_complete:
        opcode: dict_set
        isReporter: true
        inputs:
          d:
            node: data_with_file_name
          key:
            literal: "mimeType"
          value:
            variable: mime_type

      # Build outer envelope { type, version, data }
      envelope_base:
        opcode: dict_create
        isReporter: true
        inputs: {}

      envelope_with_type:
        opcode: dict_set
        isReporter: true
        inputs:
          d:
            node: envelope_base
          key:
            literal: "type"
          value:
            literal: "document-uploaded"

      envelope_with_version:
        opcode: dict_set
        isReporter: true
        inputs:
          d:
            node: envelope_with_type
          key:
            literal: "version"
          value:
            literal: 1

      envelope_complete:
        opcode: dict_set
        isReporter: true
        inputs:
          d:
            node: envelope_with_version
          key:
            literal: "data"
          value:
            node: data_complete

      # Store and stringify
      build_message:
        opcode: data_set_variable_to
        next: stringify_message
        inputs:
          VARIABLE:
            literal: "message_dict"
          VALUE:
            node: envelope_complete

      do_stringify:
        opcode: json_stringify
        isReporter: true
        inputs:
          value:
            variable: message_dict

      stringify_message:
        opcode: data_set_variable_to
        next: publish_message
        inputs:
          VARIABLE:
            literal: "message_dict"
          VALUE:
            node: do_create_publisher

      do_publish:
        opcode: pubsub_publish_message_with_attributes
        isReporter: true
        inputs:
          publisher:
            node: do_create_publisher
          data:
            node: do_stringify
          attributes:
            literal: {}

      publish_message:
        opcode: io_print
        next: close_publisher
        inputs:
          STRING:
            literal: "Message published to document-uploaded topic\n"

      close_publisher:
        opcode: pubsub_close_publisher
        next: null
        inputs:
          publisher:
            node: do_create_publisher
