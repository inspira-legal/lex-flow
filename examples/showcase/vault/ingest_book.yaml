# Book Ingestion Workflow - Vault / Book Collection RAG Pipeline
#
# Processes a PDF book from Google Cloud Storage: downloads, extracts text,
# chunks it intelligently, generates embeddings, and stores in Qdrant.
#
# Run via CLI:
#   lexflow examples/showcase/vault/ingest_book.yaml \
#     --input bucket=mvp-personal-vault \
#     --input objeto=solar_system.pdf \
#     --input livro_id=solar-system-001 \
#     --input projeto_gcp=inspira-development
#
# Run via Web UI:
#   Load this file and use inputs:
#   {
#     "bucket": "mvp-personal-vault",
#     "objeto": "solar_system.pdf",
#     "livro_id": "solar-system-001",
#     "projeto_gcp": "inspira-development"
#   }
#
# Requirements:
#   pip install lexflow[rag,gcs]
#   gcloud auth application-default login
#   docker run -d -p 6333:6333 qdrant/qdrant

workflows:
  - name: main
    interface:
      inputs: [bucket, objeto, livro_id, projeto_gcp, qdrant_url, collection, chunk_size, overlap]
      outputs: []
    variables:
      # Input parameters
      bucket: ""
      objeto: ""
      livro_id: ""
      projeto_gcp: ""
      qdrant_url: "http://localhost:6333"
      collection: "livros"
      chunk_size: 1000
      overlap: 200
      # State variables
      gcs_client: null
      pdf_bytes: null
      qdrant_client: null
      pdf_pages: []
      chunks: []
      chunk_texts: []
      chunk_count: 0
      embeddings: []
      ids: []
      payloads: []
      metadata: {}
      build_result: {}
      source_path: ""
      # Timing variables
      pipeline_t0: 0
      step1_t0: 0
      step2_t0: 0
      step3_t0: 0
      step4_t0: 0
      step5_t0: 0
      step6_t0: 0
      step_t1: 0
    nodes:
      start:
        opcode: workflow_start
        next: build_source_path
        inputs: {}

      # Build source path for display (gs://bucket/objeto)
      source_path_prefix:
        opcode: operator_add
        isReporter: true
        inputs:
          left:
            literal: "gs://"
          right:
            variable: bucket

      source_path_full:
        opcode: operator_add
        isReporter: true
        inputs:
          left:
            node: source_path_prefix
          right:
            node: source_path_suffix

      source_path_suffix:
        opcode: operator_add
        isReporter: true
        inputs:
          left:
            literal: "/"
          right:
            variable: objeto

      build_source_path:
        opcode: data_set_variable_to
        next: save_pipeline_start
        inputs:
          VARIABLE:
            literal: "source_path"
          VALUE:
            node: source_path_full

      # ========================================================================
      # PIPELINE START TIME
      # ========================================================================
      get_pipeline_start:
        opcode: util_time_now
        isReporter: true
        inputs: {}

      save_pipeline_start:
        opcode: data_set_variable_to
        next: print_header
        inputs:
          VARIABLE:
            literal: "pipeline_t0"
          VALUE:
            node: get_pipeline_start

      # ========================================================================
      # HEADER
      # ========================================================================
      print_header:
        opcode: io_print
        next: print_separator
        inputs:
          STRING:
            literal: "\n================================================================================\n"

      print_separator:
        opcode: io_print
        next: print_title
        inputs:
          STRING:
            literal: "                   VAULT - BOOK INGESTION PIPELINE\n"

      print_title:
        opcode: io_print
        next: print_settings_header
        inputs:
          STRING:
            literal: "================================================================================\n\n"

      # Print settings
      print_settings_header:
        opcode: io_print
        next: print_bucket
        inputs:
          STRING:
            literal: "Settings:\n"

      format_bucket:
        opcode: operator_add
        isReporter: true
        inputs:
          left:
            literal: "  Bucket:      "
          right:
            node: bucket_with_newline

      bucket_with_newline:
        opcode: operator_add
        isReporter: true
        inputs:
          left:
            variable: bucket
          right:
            literal: "\n"

      print_bucket:
        opcode: io_print
        next: print_objeto
        inputs:
          STRING:
            node: format_bucket

      format_objeto:
        opcode: operator_add
        isReporter: true
        inputs:
          left:
            literal: "  Objeto:      "
          right:
            node: objeto_with_newline

      objeto_with_newline:
        opcode: operator_add
        isReporter: true
        inputs:
          left:
            variable: objeto
          right:
            literal: "\n"

      print_objeto:
        opcode: io_print
        next: print_livro_id
        inputs:
          STRING:
            node: format_objeto

      format_livro_id:
        opcode: operator_add
        isReporter: true
        inputs:
          left:
            literal: "  Livro ID:    "
          right:
            node: livro_id_with_newline

      livro_id_with_newline:
        opcode: operator_add
        isReporter: true
        inputs:
          left:
            variable: livro_id
          right:
            literal: "\n"

      print_livro_id:
        opcode: io_print
        next: print_collection
        inputs:
          STRING:
            node: format_livro_id

      format_collection:
        opcode: operator_add
        isReporter: true
        inputs:
          left:
            literal: "  Collection:  "
          right:
            node: collection_with_newline

      collection_with_newline:
        opcode: operator_add
        isReporter: true
        inputs:
          left:
            variable: collection
          right:
            literal: "\n\n"

      print_collection:
        opcode: io_print
        next: save_step1_start
        inputs:
          STRING:
            node: format_collection

      # ========================================================================
      # STEP 1: Create GCS Client
      # ========================================================================
      get_step1_start:
        opcode: util_time_now
        isReporter: true
        inputs: {}

      save_step1_start:
        opcode: data_set_variable_to
        next: print_step1
        inputs:
          VARIABLE:
            literal: "step1_t0"
          VALUE:
            node: get_step1_start

      print_step1:
        opcode: io_print
        next: create_gcs_client
        inputs:
          STRING:
            literal: "[1/6] Criando cliente GCS... "

      do_create_gcs_client:
        opcode: gcs_create_client
        isReporter: true
        inputs: {}

      create_gcs_client:
        opcode: data_set_variable_to
        next: save_step1_end
        inputs:
          VARIABLE:
            literal: "gcs_client"
          VALUE:
            node: do_create_gcs_client

      get_step1_end:
        opcode: util_time_now
        isReporter: true
        inputs: {}

      save_step1_end:
        opcode: data_set_variable_to
        next: print_step1_done
        inputs:
          VARIABLE:
            literal: "step_t1"
          VALUE:
            node: get_step1_end

      step1_duration:
        opcode: util_format_duration
        isReporter: true
        inputs:
          start:
            variable: step1_t0
          end:
            variable: step_t1

      step1_done_msg:
        opcode: string_format
        isReporter: true
        inputs:
          template:
            literal: "OK ({0})\n"
          VALUES:
            node: step1_duration

      print_step1_done:
        opcode: io_print
        next: save_step2_start
        inputs:
          STRING:
            node: step1_done_msg

      # ========================================================================
      # STEP 2: Download PDF from GCS
      # ========================================================================
      get_step2_start:
        opcode: util_time_now
        isReporter: true
        inputs: {}

      save_step2_start:
        opcode: data_set_variable_to
        next: print_step2
        inputs:
          VARIABLE:
            literal: "step2_t0"
          VALUE:
            node: get_step2_start

      print_step2:
        opcode: io_print
        next: download_pdf
        inputs:
          STRING:
            literal: "[2/6] Baixando PDF do GCS... "

      do_download_pdf:
        opcode: gcs_download_object_as_bytes
        isReporter: true
        inputs:
          client:
            variable: gcs_client
          bucket_name:
            variable: bucket
          object_name:
            variable: objeto

      download_pdf:
        opcode: data_set_variable_to
        next: save_step2_end
        inputs:
          VARIABLE:
            literal: "pdf_bytes"
          VALUE:
            node: do_download_pdf

      get_step2_end:
        opcode: util_time_now
        isReporter: true
        inputs: {}

      save_step2_end:
        opcode: data_set_variable_to
        next: print_step2_done
        inputs:
          VARIABLE:
            literal: "step_t1"
          VALUE:
            node: get_step2_end

      step2_duration:
        opcode: util_format_duration
        isReporter: true
        inputs:
          start:
            variable: step2_t0
          end:
            variable: step_t1

      step2_done_msg:
        opcode: string_format
        isReporter: true
        inputs:
          template:
            literal: "OK ({0})\n"
          VALUES:
            node: step2_duration

      print_step2_done:
        opcode: io_print
        next: save_step3_start
        inputs:
          STRING:
            node: step2_done_msg

      # ========================================================================
      # STEP 3: Connect to Qdrant
      # ========================================================================
      get_step3_start:
        opcode: util_time_now
        isReporter: true
        inputs: {}

      save_step3_start:
        opcode: data_set_variable_to
        next: print_step3
        inputs:
          VARIABLE:
            literal: "step3_t0"
          VALUE:
            node: get_step3_start

      print_step3:
        opcode: io_print
        next: connect_qdrant
        inputs:
          STRING:
            literal: "[3/6] Conectando ao Qdrant... "

      do_connect_qdrant:
        opcode: qdrant_connect
        isReporter: true
        inputs:
          url:
            variable: qdrant_url

      connect_qdrant:
        opcode: data_set_variable_to
        next: save_step3_end
        inputs:
          VARIABLE:
            literal: "qdrant_client"
          VALUE:
            node: do_connect_qdrant

      get_step3_end:
        opcode: util_time_now
        isReporter: true
        inputs: {}

      save_step3_end:
        opcode: data_set_variable_to
        next: print_step3_done
        inputs:
          VARIABLE:
            literal: "step_t1"
          VALUE:
            node: get_step3_end

      step3_duration:
        opcode: util_format_duration
        isReporter: true
        inputs:
          start:
            variable: step3_t0
          end:
            variable: step_t1

      step3_done_msg:
        opcode: string_format
        isReporter: true
        inputs:
          template:
            literal: "OK ({0})\n"
          VALUES:
            node: step3_duration

      print_step3_done:
        opcode: io_print
        next: save_step4_start
        inputs:
          STRING:
            node: step3_done_msg

      # ========================================================================
      # STEP 4: Create Collection (if not exists)
      # ========================================================================
      get_step4_start:
        opcode: util_time_now
        isReporter: true
        inputs: {}

      save_step4_start:
        opcode: data_set_variable_to
        next: print_step4
        inputs:
          VARIABLE:
            literal: "step4_t0"
          VALUE:
            node: get_step4_start

      print_step4:
        opcode: io_print
        next: create_collection
        inputs:
          STRING:
            literal: "[4/6] Criando collection (se necessario)... "

      do_create_collection:
        opcode: qdrant_create_collection
        isReporter: true
        inputs:
          client:
            variable: qdrant_client
          name:
            variable: collection
          vector_size:
            literal: 768

      create_collection:
        opcode: control_if_else
        next: save_step5_start
        inputs:
          CONDITION:
            node: do_create_collection
          THEN:
            branch: save_step4_end_created
          ELSE:
            branch: save_step4_end_exists

      # Branch: Collection was created
      get_step4_end_created:
        opcode: util_time_now
        isReporter: true
        inputs: {}

      save_step4_end_created:
        opcode: data_set_variable_to
        next: print_created
        inputs:
          VARIABLE:
            literal: "step_t1"
          VALUE:
            node: get_step4_end_created

      step4_duration_created:
        opcode: util_format_duration
        isReporter: true
        inputs:
          start:
            variable: step4_t0
          end:
            variable: step_t1

      step4_created_msg:
        opcode: string_format
        isReporter: true
        inputs:
          template:
            literal: "Criada ({0})\n"
          VALUES:
            node: step4_duration_created

      print_created:
        opcode: io_print
        next: null
        inputs:
          STRING:
            node: step4_created_msg

      # Branch: Collection already exists
      get_step4_end_exists:
        opcode: util_time_now
        isReporter: true
        inputs: {}

      save_step4_end_exists:
        opcode: data_set_variable_to
        next: print_exists
        inputs:
          VARIABLE:
            literal: "step_t1"
          VALUE:
            node: get_step4_end_exists

      step4_duration_exists:
        opcode: util_format_duration
        isReporter: true
        inputs:
          start:
            variable: step4_t0
          end:
            variable: step_t1

      step4_exists_msg:
        opcode: string_format
        isReporter: true
        inputs:
          template:
            literal: "Ja existe ({0})\n"
          VALUES:
            node: step4_duration_exists

      print_exists:
        opcode: io_print
        next: null
        inputs:
          STRING:
            node: step4_exists_msg

      # ========================================================================
      # STEP 5: Extract text from PDF bytes (per page)
      # ========================================================================
      get_step5_start:
        opcode: util_time_now
        isReporter: true
        inputs: {}

      save_step5_start:
        opcode: data_set_variable_to
        next: print_step5
        inputs:
          VARIABLE:
            literal: "step5_t0"
          VALUE:
            node: get_step5_start

      print_step5:
        opcode: io_print
        next: extract_pdf
        inputs:
          STRING:
            literal: "[5/6] Extraindo texto do PDF... "

      do_extract_pdf:
        opcode: pdf_extract_pages_from_bytes
        isReporter: true
        inputs:
          data:
            variable: pdf_bytes

      extract_pdf:
        opcode: data_set_variable_to
        next: save_step5_end
        inputs:
          VARIABLE:
            literal: "pdf_pages"
          VALUE:
            node: do_extract_pdf

      get_step5_end:
        opcode: util_time_now
        isReporter: true
        inputs: {}

      save_step5_end:
        opcode: data_set_variable_to
        next: print_step5_done
        inputs:
          VARIABLE:
            literal: "step_t1"
          VALUE:
            node: get_step5_end

      page_count:
        opcode: list_length
        isReporter: true
        inputs:
          items:
            variable: pdf_pages

      page_count_str:
        opcode: str
        isReporter: true
        inputs:
          value:
            node: page_count

      step5_duration:
        opcode: util_format_duration
        isReporter: true
        inputs:
          start:
            variable: step5_t0
          end:
            variable: step_t1

      step5_done_msg:
        opcode: string_format
        isReporter: true
        inputs:
          template:
            literal: "{0} paginas extraidas ({1})\n"
          VALUES:
            node: page_count_str
          VALUE_1:
            node: step5_duration

      print_step5_done:
        opcode: io_print
        next: chunk_text
        inputs:
          STRING:
            node: step5_done_msg

      # ========================================================================
      # STEP 6: Chunk, embed, and upsert
      # ========================================================================
      do_chunk_pages:
        opcode: text_chunk_pages_smart
        isReporter: true
        inputs:
          pages:
            variable: pdf_pages
          chunk_size:
            variable: chunk_size
          overlap:
            variable: overlap

      chunk_text:
        opcode: data_set_variable_to
        next: store_chunk_count
        inputs:
          VARIABLE:
            literal: "chunks"
          VALUE:
            node: do_chunk_pages

      get_chunk_count:
        opcode: list_length
        isReporter: true
        inputs:
          items:
            variable: chunks

      store_chunk_count:
        opcode: data_set_variable_to
        next: extract_chunk_texts
        inputs:
          VARIABLE:
            literal: "chunk_count"
          VALUE:
            node: get_chunk_count

      # Extract text strings from chunk dicts for embedding using list_pluck
      do_extract_chunk_texts:
        opcode: list_pluck
        isReporter: true
        inputs:
          items:
            variable: chunks
          key:
            literal: "text"

      extract_chunk_texts:
        opcode: data_set_variable_to
        next: generate_embeddings
        inputs:
          VARIABLE:
            literal: "chunk_texts"
          VALUE:
            node: do_extract_chunk_texts

      do_generate_embeddings:
        opcode: embedding_create_batch
        isReporter: true
        inputs:
          texts:
            variable: chunk_texts
          project:
            variable: projeto_gcp
          location:
            literal: "us-central1"
          model:
            literal: "text-multilingual-embedding-002"
          task_type:
            literal: "RETRIEVAL_DOCUMENT"

      generate_embeddings:
        opcode: data_set_variable_to
        next: save_step6_start
        inputs:
          VARIABLE:
            literal: "embeddings"
          VALUE:
            node: do_generate_embeddings

      get_step6_start:
        opcode: util_time_now
        isReporter: true
        inputs: {}

      save_step6_start:
        opcode: data_set_variable_to
        next: print_step6
        inputs:
          VARIABLE:
            literal: "step6_t0"
          VALUE:
            node: get_step6_start

      print_step6:
        opcode: io_print
        next: build_metadata
        inputs:
          STRING:
            literal: "[6/6] Construindo payloads e salvando no Qdrant... "

      # Build metadata dict for rag_build_chunk_payloads
      metadata_base:
        opcode: dict_create
        isReporter: true
        inputs: {}

      metadata_with_source:
        opcode: dict_set
        isReporter: true
        inputs:
          d:
            node: metadata_base
          key:
            literal: "source"
          value:
            variable: source_path

      metadata_with_livro_id:
        opcode: dict_set
        isReporter: true
        inputs:
          d:
            node: metadata_with_source
          key:
            literal: "livro_id"
          value:
            variable: livro_id

      build_metadata:
        opcode: data_set_variable_to
        next: do_build_payloads
        inputs:
          VARIABLE:
            literal: "metadata"
          VALUE:
            node: metadata_with_livro_id

      # Call rag_build_chunk_payloads (replaces ~240-line build loop)
      do_rag_build:
        opcode: rag_build_chunk_payloads
        isReporter: true
        inputs:
          chunks:
            variable: chunks
          metadata:
            variable: metadata

      do_build_payloads:
        opcode: data_set_variable_to
        next: extract_ids
        inputs:
          VARIABLE:
            literal: "build_result"
          VALUE:
            node: do_rag_build

      get_built_ids:
        opcode: dict_get
        isReporter: true
        inputs:
          d:
            variable: build_result
          key:
            literal: "ids"

      extract_ids:
        opcode: data_set_variable_to
        next: extract_payloads
        inputs:
          VARIABLE:
            literal: "ids"
          VALUE:
            node: get_built_ids

      get_built_payloads:
        opcode: dict_get
        isReporter: true
        inputs:
          d:
            variable: build_result
          key:
            literal: "payloads"

      extract_payloads:
        opcode: data_set_variable_to
        next: do_upsert
        inputs:
          VARIABLE:
            literal: "payloads"
          VALUE:
            node: get_built_payloads

      # ========================================================================
      # Perform batch upsert to Qdrant
      # ========================================================================
      do_qdrant_upsert:
        opcode: qdrant_upsert_batch
        isReporter: true
        inputs:
          client:
            variable: qdrant_client
          collection:
            variable: collection
          point_ids:
            variable: ids
          vectors:
            variable: embeddings
          payloads:
            variable: payloads

      do_upsert:
        opcode: control_if_else
        next: close_qdrant
        inputs:
          CONDITION:
            node: do_qdrant_upsert
          THEN:
            branch: save_step6_end_ok
          ELSE:
            branch: save_step6_end_fail

      # Branch: Upsert succeeded
      get_step6_end_ok:
        opcode: util_time_now
        isReporter: true
        inputs: {}

      save_step6_end_ok:
        opcode: data_set_variable_to
        next: print_upsert_done
        inputs:
          VARIABLE:
            literal: "step_t1"
          VALUE:
            node: get_step6_end_ok

      step6_duration_ok:
        opcode: util_format_duration
        isReporter: true
        inputs:
          start:
            variable: step6_t0
          end:
            variable: step_t1

      step6_ok_msg:
        opcode: string_format
        isReporter: true
        inputs:
          template:
            literal: "OK ({0})\n"
          VALUES:
            node: step6_duration_ok

      print_upsert_done:
        opcode: io_print
        next: null
        inputs:
          STRING:
            node: step6_ok_msg

      # Branch: Upsert failed
      get_step6_end_fail:
        opcode: util_time_now
        isReporter: true
        inputs: {}

      save_step6_end_fail:
        opcode: data_set_variable_to
        next: print_upsert_failed
        inputs:
          VARIABLE:
            literal: "step_t1"
          VALUE:
            node: get_step6_end_fail

      step6_duration_fail:
        opcode: util_format_duration
        isReporter: true
        inputs:
          start:
            variable: step6_t0
          end:
            variable: step_t1

      step6_fail_msg:
        opcode: string_format
        isReporter: true
        inputs:
          template:
            literal: "FALHOU! ({0})\n"
          VALUES:
            node: step6_duration_fail

      print_upsert_failed:
        opcode: io_print
        next: null
        inputs:
          STRING:
            node: step6_fail_msg

      # ========================================================================
      # CLEANUP - Close clients
      # ========================================================================
      do_close_gcs:
        opcode: gcs_close_client
        isReporter: true
        inputs:
          client:
            variable: gcs_client

      close_qdrant:
        opcode: data_set_variable_to
        next: print_footer
        inputs:
          VARIABLE:
            literal: "gcs_client"
          VALUE:
            node: do_close_gcs

      # ========================================================================
      # FOOTER
      # ========================================================================
      print_footer:
        opcode: io_print
        next: print_success
        inputs:
          STRING:
            literal: "\n================================================================================\n"

      chunk_count_str:
        opcode: str
        isReporter: true
        inputs:
          value:
            variable: chunk_count

      success_msg_part1:
        opcode: operator_add
        isReporter: true
        inputs:
          left:
            literal: "SUCESSO: Indexados "
          right:
            node: chunk_count_str

      success_msg_part2:
        opcode: operator_add
        isReporter: true
        inputs:
          left:
            node: success_msg_part1
          right:
            literal: " chunks do livro '"

      success_msg_part3:
        opcode: operator_add
        isReporter: true
        inputs:
          left:
            node: success_msg_part2
          right:
            variable: livro_id

      success_msg_part4:
        opcode: operator_add
        isReporter: true
        inputs:
          left:
            node: success_msg_part3
          right:
            literal: "' na collection '"

      success_msg_part5:
        opcode: operator_add
        isReporter: true
        inputs:
          left:
            node: success_msg_part4
          right:
            variable: collection

      success_msg:
        opcode: operator_add
        isReporter: true
        inputs:
          left:
            node: success_msg_part5
          right:
            literal: "'\n"

      print_success:
        opcode: io_print
        next: print_total_time
        inputs:
          STRING:
            node: success_msg

      # Total pipeline time
      get_pipeline_end:
        opcode: util_time_now
        isReporter: true
        inputs: {}

      total_duration:
        opcode: util_format_duration
        isReporter: true
        inputs:
          start:
            variable: pipeline_t0
          end:
            node: get_pipeline_end

      total_time_msg:
        opcode: string_format
        isReporter: true
        inputs:
          template:
            literal: "Tempo total: {0}\n"
          VALUES:
            node: total_duration

      print_total_time:
        opcode: io_print
        next: print_final_separator
        inputs:
          STRING:
            node: total_time_msg

      print_final_separator:
        opcode: io_print
        next: null
        inputs:
          STRING:
            literal: "================================================================================\n\n"
