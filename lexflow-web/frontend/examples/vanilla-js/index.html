<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LexFlow Editor - Vanilla JS Example</title>
  <link rel="stylesheet" href="../../dist/lexflow-editor.css">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      /* Don't reset padding - it breaks Tailwind utility classes */
    }

    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: #0f172a;
      color: #f8fafc;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .toolbar {
      display: flex;
      gap: 8px;
      padding: 12px 16px;
      background: #1e293b;
      border-bottom: 1px solid #334155;
      flex-wrap: wrap;
      align-items: center;
    }

    .toolbar button {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      background: #3b82f6;
      color: white;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s;
    }

    .toolbar button:hover {
      background: #2563eb;
    }

    .toolbar button.secondary {
      background: #475569;
    }

    .toolbar button.secondary:hover {
      background: #64748b;
    }

    .toolbar button.danger {
      background: #ef4444;
    }

    .toolbar button.danger:hover {
      background: #dc2626;
    }

    .toolbar .spacer {
      flex: 1;
    }

    .toolbar .status {
      font-size: 13px;
      color: #94a3b8;
    }

    #editor-container {
      flex: 1;
      min-height: 600px;
    }

    .output-panel {
      background: #1e293b;
      border-top: 1px solid #334155;
      padding: 16px;
      max-height: 200px;
      overflow: auto;
    }

    .output-panel h3 {
      font-size: 14px;
      color: #94a3b8;
      margin-bottom: 8px;
    }

    .output-panel pre {
      font-family: 'JetBrains Mono', monospace;
      font-size: 13px;
      white-space: pre-wrap;
      color: #34d399;
    }

    .output-panel pre.error {
      color: #f87171;
    }
  </style>
</head>
<body>
  <div class="toolbar">
    <button onclick="runWorkflow()">Run Workflow</button>
    <button class="secondary" onclick="toggleCodeEditor()">Toggle Code Editor</button>
    <button class="secondary" onclick="togglePalette()">Toggle Palette</button>
    <button class="secondary" onclick="toggleTheme()">Toggle Theme</button>
    <button class="secondary" onclick="loadExample()">Load Example</button>
    <div class="spacer"></div>
    <span class="status" id="status">Ready</span>
  </div>

  <div id="editor-container"></div>

  <div class="output-panel">
    <h3>Output</h3>
    <pre id="output">Click "Run Workflow" to execute...</pre>
  </div>

  <script src="../../dist/lexflow-editor.umd.js"></script>
  <script>
    // Initial workflow YAML
    const initialWorkflow = `workflows:
  - name: main
    interface:
      inputs: []
      outputs: []
    variables:
      counter: 0
    nodes:
      start:
        next: init
      init:
        opcode: data_set_variable_to
        inputs:
          VARIABLE: { literal: "counter" }
          VALUE: { literal: 1 }
        next: loop
      loop:
        opcode: control_repeat
        inputs:
          TIMES: { literal: 5 }
        branches:
          BODY: print_counter
        next: done
      print_counter:
        opcode: io_print
        inputs:
          MESSAGE: { variable: "counter" }
        next: increment
      increment:
        opcode: data_change_variable_by
        inputs:
          VARIABLE: { literal: "counter" }
          VALUE: { literal: 1 }
      done:
        opcode: io_print
        inputs:
          MESSAGE: { literal: "Done counting!" }
`;

    // Mount the editor
    let editor = null;
    let currentTheme = 'dark';

    function initEditor() {
      editor = LexFlowEditor.mount('#editor-container', {
        initialSource: initialWorkflow,
        theme: currentTheme,
        executionUrl: '/api', // Backend API URL
        showCodeEditor: true,
        showPalette: true,
        showExecutionPanel: true,
        onSourceChange: (source) => {
          document.getElementById('status').textContent = 'Modified';
        },
        onExecute: (result) => {
          const outputEl = document.getElementById('output');
          if (result.success) {
            outputEl.className = '';
            outputEl.textContent = result.output || 'Execution completed successfully';
          } else {
            outputEl.className = 'error';
            outputEl.textContent = 'Error: ' + (result.error || 'Unknown error');
          }
          document.getElementById('status').textContent = result.success ? 'Success' : 'Error';
        },
        onError: (error) => {
          const outputEl = document.getElementById('output');
          outputEl.className = 'error';
          outputEl.textContent = 'Error: ' + error;
        },
        onReady: () => {
          console.log('LexFlow Editor is ready!');
        }
      });
    }

    // Run the workflow
    async function runWorkflow() {
      if (!editor) return;

      document.getElementById('status').textContent = 'Running...';
      document.getElementById('output').textContent = 'Executing workflow...';

      try {
        const result = await editor.execute();
        // onExecute callback handles the result
      } catch (err) {
        document.getElementById('output').className = 'error';
        document.getElementById('output').textContent = 'Error: ' + err.message;
        document.getElementById('status').textContent = 'Error';
      }
    }

    // Toggle code editor panel
    function toggleCodeEditor() {
      if (editor) {
        editor.toggleCodeEditor();
      }
    }

    // Toggle node palette
    function togglePalette() {
      if (editor) {
        editor.togglePalette();
      }
    }

    // Toggle theme
    function toggleTheme() {
      currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
      // Need to remount to change theme (or implement theme change in component)
      if (editor) {
        const source = editor.getSource();
        editor.destroy();
        editor = LexFlowEditor.mount('#editor-container', {
          initialSource: source,
          theme: currentTheme,
          executionUrl: '/api',
          showCodeEditor: true,
          showPalette: true,
          showExecutionPanel: true,
          onSourceChange: (source) => {
            document.getElementById('status').textContent = 'Modified';
          },
          onExecute: (result) => {
            const outputEl = document.getElementById('output');
            if (result.success) {
              outputEl.className = '';
              outputEl.textContent = result.output || 'Execution completed successfully';
            } else {
              outputEl.className = 'error';
              outputEl.textContent = 'Error: ' + (result.error || 'Unknown error');
            }
          }
        });
      }
    }

    // Load example workflow
    function loadExample() {
      const exampleWorkflow = `workflows:
  - name: main
    interface:
      inputs: []
      outputs: []
    variables:
      name: "World"
    nodes:
      start:
        next: greet
      greet:
        opcode: io_print
        inputs:
          MESSAGE:
            node: build_greeting
      build_greeting:
        opcode: operator_join
        inputs:
          STRING1: { literal: "Hello, " }
          STRING2: { variable: "name" }
`;

      if (editor) {
        editor.setSource(exampleWorkflow);
        document.getElementById('status').textContent = 'Example loaded';
      }
    }

    // Get current source (for debugging)
    function getSource() {
      if (editor) {
        console.log(editor.getSource());
      }
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', initEditor);
  </script>
</body>
</html>
